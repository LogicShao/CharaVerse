<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å¿«é€Ÿæµ‹è¯• - 3ä¸ªè§’è‰²åŠ è½½éªŒè¯</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .status {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .status h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    .char-card {
      background: #f8f9fa;
      border-left: 5px solid #28a745;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      transition: transform 0.2s;
    }
    .char-card:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .char-card.error {
      border-left-color: #dc3545;
      background: #fff5f5;
    }
    .char-name {
      font-size: 1.4rem;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    .char-info {
      color: #666;
      line-height: 1.6;
      font-size: 0.95rem;
    }
    .success {
      color: #28a745;
      font-weight: bold;
    }
    .error {
      color: #dc3545;
      font-weight: bold;
    }
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      font-size: 1.5rem;
      margin-top: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .summary.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .summary.fail {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    }
    .loading {
      text-align: center;
      color: white;
      font-size: 1.2rem;
      padding: 40px;
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    pre {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.85rem;
      margin-top: 10px;
    }
    button {
      background: white;
      color: #667eea;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .actions {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”¬ CharaVerse è§’è‰²åŠ è½½æµ‹è¯•</h1>
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>æ­£åœ¨åŠ è½½å’ŒéªŒè¯è§’è‰²æ•°æ®...</p>
    </div>
    <div id="result" style="display: none;"></div>
  </div>

  <script type="module">
    import { safeValidateCharacter } from '/src/schemas/character.schema.ts'

    async function runTest() {
      const resultDiv = document.getElementById('result')
      const loadingDiv = document.getElementById('loading')

      const files = [
        { path: '/data/characters/char-001.json', name: 'Aria Morningstar (è‰¾è‰å¨…Â·æ™¨æ˜Ÿ)' },
        { path: '/data/characters/char-002.json', name: 'Silas Nightwind (å¡æ‹‰æ–¯Â·å¤œé£)' },
        { path: '/data/characters/char-003.json', name: 'Lia Dawn (è‰äºšÂ·æ™¨æ›¦)' }
      ]

      let html = '<div class="status"><h2>ğŸ“Š åŠ è½½ç»“æœ</h2>'
      const results = []

      for (const file of files) {
        try {
          // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
          const response = await fetch(file.path + '?t=' + Date.now())

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const data = await response.json()
          const validation = safeValidateCharacter(data)

          if (validation.success && validation.data) {
            const char = validation.data
            results.push({ success: true, data: char })

            html += `
              <div class="char-card">
                <div class="char-name">âœ… ${char.basic.nameCn} (${char.basic.nameEn})</div>
                <div class="char-info">
                  <strong>ID:</strong> ${char.basic.id}<br/>
                  <strong>æ€§åˆ«:</strong> ${char.basic.gender}<br/>
                  <strong>èŒä¸š:</strong> ${char.skills.occupation}<br/>
                  <strong>ä½“å‹:</strong> ${char.appearance.body.bodyType}<br/>
                  <strong>å‘é•¿:</strong> ${char.appearance.hair.length}<br/>
                  <strong>æ–‡ä»¶:</strong> ${file.path}
                </div>
              </div>
            `
          } else {
            results.push({ success: false, error: validation.error })

            html += `
              <div class="char-card error">
                <div class="char-name">âŒ ${file.name}</div>
                <div class="char-info">
                  <strong class="error">éªŒè¯å¤±è´¥</strong><br/>
                  <strong>æ–‡ä»¶:</strong> ${file.path}
                  <pre>${JSON.stringify(validation.error.errors, null, 2)}</pre>
                </div>
              </div>
            `
          }
        } catch (error) {
          results.push({ success: false, error: error.message })

          html += `
            <div class="char-card error">
              <div class="char-name">âŒ ${file.name}</div>
              <div class="char-info">
                <strong class="error">åŠ è½½å¤±è´¥</strong><br/>
                <strong>é”™è¯¯:</strong> ${error.message}<br/>
                <strong>æ–‡ä»¶:</strong> ${file.path}
              </div>
            </div>
          `
        }
      }

      html += '</div>'

      const successCount = results.filter(r => r.success).length
      const summaryClass = successCount === 3 ? 'success' : 'fail'

      html += `
        <div class="summary ${summaryClass}">
          <h2>ğŸ¯ æµ‹è¯•ç»“æœ</h2>
          <p style="font-size: 2.5rem; margin: 20px 0; font-weight: bold;">
            ${successCount} / 3
          </p>
          <p style="font-size: 1.2rem;">
            ${successCount === 3
              ? 'âœ… æ‰€æœ‰è§’è‰²éƒ½èƒ½æ­£å¸¸åŠ è½½ï¼'
              : `âš ï¸ åªæœ‰ ${successCount} ä¸ªè§’è‰²èƒ½åŠ è½½`}
          </p>
        </div>
      `

      if (successCount === 3) {
        html += `
          <div class="status">
            <h2>ğŸ‰ è§£å†³æ–¹æ¡ˆ</h2>
            <p style="color: #28a745; font-size: 1.1rem; line-height: 1.8;">
              æ‰€æœ‰JSONæ–‡ä»¶éƒ½èƒ½æ­£å¸¸åŠ è½½å’ŒéªŒè¯ï¼<br/><br/>
              å¦‚æœä¸»é¡µä»ç„¶åªæ˜¾ç¤º2ä¸ªè§’è‰²ï¼Œè¯·å°è¯•ä»¥ä¸‹æ“ä½œï¼š
            </p>
            <ol style="margin: 20px 0; padding-left: 30px; line-height: 2;">
              <li><strong>ç¡¬åˆ·æ–°æµè§ˆå™¨ï¼š</strong> æŒ‰ <code>Ctrl + Shift + R</code> (Windows) æˆ– <code>Cmd + Shift + R</code> (Mac)</li>
              <li><strong>æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ï¼š</strong> æ‰“å¼€å¼€å‘è€…å·¥å…· (F12) â†’ Application â†’ Clear storage â†’ Clear site data</li>
              <li><strong>é‡æ–°åŠ è½½æ•°æ®ï¼š</strong> ç‚¹å‡»ä¸»é¡µçš„"åŠ è½½ç¤ºä¾‹æ•°æ®"æŒ‰é’®</li>
            </ol>
            <div class="actions">
              <button onclick="localStorage.clear(); alert('âœ… LocalStorage å·²æ¸…ç©ºï¼\\n\\nè¯·åˆ·æ–°é¡µé¢åç‚¹å‡»\\'åŠ è½½ç¤ºä¾‹æ•°æ®\\'æŒ‰é’®ã€‚')">
                æ¸…ç©º LocalStorage
              </button>
              <button onclick="location.href='/'">
                è¿”å›ä¸»é¡µ
              </button>
            </div>
          </div>
        `
      } else {
        html += `
          <div class="status">
            <h2>âš ï¸ é—®é¢˜è¯Šæ–­</h2>
            <p style="color: #dc3545; font-size: 1.1rem; line-height: 1.8;">
              éƒ¨åˆ†è§’è‰²æ— æ³•åŠ è½½ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºï¼š
            </p>
            <ul style="margin: 20px 0; padding-left: 30px; line-height: 2;">
              <li>JSONæ–‡ä»¶éªŒè¯å¤±è´¥ï¼ˆè¯·æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯è¯¦æƒ…ï¼‰</li>
              <li>æ–‡ä»¶è¯»å–æƒé™é—®é¢˜</li>
              <li>Viteå¼€å‘æœåŠ¡å™¨é…ç½®é—®é¢˜</li>
            </ul>
            <div class="actions">
              <button onclick="location.reload()">
                é‡æ–°æµ‹è¯•
              </button>
              <button onclick="location.href='/debug.html'">
                æ‰“å¼€å®Œæ•´è°ƒè¯•å·¥å…·
              </button>
            </div>
          </div>
        `
      }

      loadingDiv.style.display = 'none'
      resultDiv.style.display = 'block'
      resultDiv.innerHTML = html
    }

    // é¡µé¢åŠ è½½åç«‹å³è¿è¡Œæµ‹è¯•
    runTest()
  </script>
</body>
</html>

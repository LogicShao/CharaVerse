<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è°ƒè¯•å·¥å…· - CharaVerse</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #666; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
    .success { color: #059669; }
    .error { color: #dc2626; }
    .warning { color: #d97706; }
    pre {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 13px;
    }
    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #4f46e5;
    }
    button.danger {
      background: #dc2626;
    }
    button.danger:hover {
      background: #b91c1c;
    }
    .info-box {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 12px;
      margin: 10px 0;
    }
    .char-card {
      border: 1px solid #e0e0e0;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      background: #fafafa;
    }
    .char-card.valid {
      border-left: 4px solid #059669;
    }
    .char-card.invalid {
      border-left: 4px solid #dc2626;
    }
  </style>
</head>
<body>
  <h1>ğŸ” CharaVerse è°ƒè¯•å·¥å…·</h1>

  <div class="section">
    <h2>1. LocalStorage æ£€æŸ¥</h2>
    <button onclick="checkLocalStorage()">æ£€æŸ¥ LocalStorage</button>
    <button onclick="clearLocalStorage()" class="danger">æ¸…ç©º LocalStorage</button>
    <div id="localStorageResult"></div>
  </div>

  <div class="section">
    <h2>2. JSON æ–‡ä»¶åŠ è½½æµ‹è¯•</h2>
    <button onclick="testJsonFiles()">æµ‹è¯•åŠ è½½ JSON æ–‡ä»¶</button>
    <div id="jsonFilesResult"></div>
  </div>

  <div class="section">
    <h2>3. éªŒè¯æµ‹è¯•</h2>
    <button onclick="testValidation()">æµ‹è¯• Zod éªŒè¯</button>
    <div id="validationResult"></div>
  </div>

  <div class="section">
    <h2>4. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
    <button onclick="testFullFlow()">æµ‹è¯•å®Œæ•´åŠ è½½æµç¨‹</button>
    <div id="fullFlowResult"></div>
  </div>

  <script type="module">
    import { safeValidateCharacter } from '/src/schemas/character.schema.ts'
    import { characterService } from '/src/services/characterService.ts'

    window.safeValidateCharacter = safeValidateCharacter
    window.characterService = characterService

    window.checkLocalStorage = function() {
      const result = document.getElementById('localStorageResult')
      result.innerHTML = '<h3>LocalStorage å†…å®¹ï¼š</h3>'

      const keys = Object.keys(localStorage).filter(key => key.startsWith('charaverse'))

      if (keys.length === 0) {
        result.innerHTML += '<p class="warning">âš ï¸ LocalStorage ä¸­æ²¡æœ‰ CharaVerse æ•°æ®</p>'
        result.innerHTML += '<div class="info-box">è¿™æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœä½ å·²ç»æ¸…ç©ºäº†ç¼“å­˜ã€‚ç‚¹å‡»ä¸»é¡µçš„"åŠ è½½ç¤ºä¾‹æ•°æ®"æŒ‰é’®æ¥åŠ è½½è§’è‰²ã€‚</div>'
      } else {
        result.innerHTML += `<p class="success">âœ… æ‰¾åˆ° ${keys.length} ä¸ª CharaVerse æ¡ç›®</p>`

        keys.forEach(key => {
          try {
            const value = localStorage.getItem(key)
            const parsed = JSON.parse(value)

            if (key.includes('_list')) {
              result.innerHTML += `<div class="char-card"><strong>${key}</strong><pre>${JSON.stringify(parsed, null, 2)}</pre></div>`
            } else {
              result.innerHTML += `<div class="char-card"><strong>${key}</strong><br/>è§’è‰²: ${parsed.basic?.nameCn || parsed.basic?.nameEn || 'æœªçŸ¥'}</div>`
            }
          } catch (e) {
            result.innerHTML += `<div class="char-card invalid"><strong>${key}</strong><br/><span class="error">è§£æé”™è¯¯: ${e.message}</span></div>`
          }
        })
      }
    }

    window.clearLocalStorage = function() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ CharaVerse æ•°æ®å—ï¼Ÿ')) return

      const keys = Object.keys(localStorage).filter(key => key.startsWith('charaverse'))
      keys.forEach(key => localStorage.removeItem(key))

      const result = document.getElementById('localStorageResult')
      result.innerHTML = '<p class="success">âœ… LocalStorage å·²æ¸…ç©º</p>'
      result.innerHTML += '<div class="info-box">è¯·åˆ·æ–°ä¸»é¡µå¹¶ç‚¹å‡»"åŠ è½½ç¤ºä¾‹æ•°æ®"æŒ‰é’®ã€‚</div>'
    }

    window.testJsonFiles = async function() {
      const result = document.getElementById('jsonFilesResult')
      result.innerHTML = '<h3>åŠ è½½ JSON æ–‡ä»¶...</h3>'

      const files = [
        { path: '/data/characters/char-001.json', name: 'char-001 (Aria Morningstar)' },
        { path: '/data/characters/char-002.json', name: 'char-002 (Silas Nightwind)' },
        { path: '/data/characters/char-003.json', name: 'char-003 (Lia Dawn)' }
      ]

      for (const file of files) {
        try {
          const response = await fetch(file.path + '?t=' + Date.now()) // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜

          if (!response.ok) {
            result.innerHTML += `<div class="char-card invalid">
              <strong class="error">âŒ ${file.name}</strong><br/>
              HTTPé”™è¯¯: ${response.status} ${response.statusText}
            </div>`
            continue
          }

          const data = await response.json()
          const charName = data.basic?.nameCn || data.basic?.nameEn || 'æœªçŸ¥'

          result.innerHTML += `<div class="char-card valid">
            <strong class="success">âœ… ${file.name}</strong><br/>
            è§’è‰²å: ${charName}<br/>
            ID: ${data.basic?.id}<br/>
            ä½“å‹: ${data.appearance?.body?.bodyType || 'N/A'}<br/>
            å‘é•¿: ${data.appearance?.hair?.length || 'N/A'}
          </div>`
        } catch (error) {
          result.innerHTML += `<div class="char-card invalid">
            <strong class="error">âŒ ${file.name}</strong><br/>
            é”™è¯¯: ${error.message}
          </div>`
        }
      }
    }

    window.testValidation = async function() {
      const result = document.getElementById('validationResult')
      result.innerHTML = '<h3>éªŒè¯æµ‹è¯•...</h3>'

      const files = [
        { path: '/data/characters/char-001.json', name: 'char-001' },
        { path: '/data/characters/char-002.json', name: 'char-002' },
        { path: '/data/characters/char-003.json', name: 'char-003' }
      ]

      for (const file of files) {
        try {
          const response = await fetch(file.path + '?t=' + Date.now())
          const data = await response.json()

          const validation = window.safeValidateCharacter(data)

          if (validation.success) {
            result.innerHTML += `<div class="char-card valid">
              <strong class="success">âœ… ${file.name} éªŒè¯é€šè¿‡</strong><br/>
              è§’è‰²: ${data.basic.nameCn} (${data.basic.nameEn})
            </div>`
          } else {
            result.innerHTML += `<div class="char-card invalid">
              <strong class="error">âŒ ${file.name} éªŒè¯å¤±è´¥</strong><br/>
              <pre>${JSON.stringify(validation.error.errors, null, 2)}</pre>
            </div>`
          }
        } catch (error) {
          result.innerHTML += `<div class="char-card invalid">
            <strong class="error">âŒ ${file.name} å¤„ç†å¤±è´¥</strong><br/>
            é”™è¯¯: ${error.message}
          </div>`
        }
      }
    }

    window.testFullFlow = async function() {
      const result = document.getElementById('fullFlowResult')
      result.innerHTML = '<h3>å®Œæ•´æµç¨‹æµ‹è¯•...</h3>'

      try {
        // 1. æ¸…ç©º localStorage
        const keys = Object.keys(localStorage).filter(key => key.startsWith('charaverse'))
        keys.forEach(key => localStorage.removeItem(key))
        result.innerHTML += '<p class="success">âœ… æ­¥éª¤1: LocalStorage å·²æ¸…ç©º</p>'

        // 2. åŠ è½½JSONæ–‡ä»¶
        const files = [
          '/data/characters/char-001.json',
          '/data/characters/char-002.json',
          '/data/characters/char-003.json'
        ]

        const characters = []
        for (const path of files) {
          const response = await fetch(path + '?t=' + Date.now())
          const data = await response.json()

          const validation = window.safeValidateCharacter(data)
          if (validation.success && validation.data) {
            characters.push(validation.data)
            result.innerHTML += `<p class="success">âœ… åŠ è½½å¹¶éªŒè¯é€šè¿‡: ${data.basic.nameCn}</p>`
          } else {
            result.innerHTML += `<p class="error">âŒ éªŒè¯å¤±è´¥: ${path}</p>`
            result.innerHTML += `<pre>${JSON.stringify(validation.error?.errors, null, 2)}</pre>`
          }
        }

        result.innerHTML += `<h3>ç»“æœï¼š</h3>`
        result.innerHTML += `<p><strong>æˆåŠŸåŠ è½½ ${characters.length} / 3 ä¸ªè§’è‰²</strong></p>`

        if (characters.length === 3) {
          result.innerHTML += '<div class="info-box success">âœ… æ‰€æœ‰è§’è‰²éƒ½èƒ½æ­£å¸¸åŠ è½½å’ŒéªŒè¯ï¼<br/>é—®é¢˜å¯èƒ½åœ¨äºï¼š<ul><li>æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ JSON æ–‡ä»¶ï¼ˆéœ€è¦ç¡¬åˆ·æ–°ï¼‰</li><li>ä»£ç åŠ è½½é€»è¾‘æœ‰é—®é¢˜</li></ul></div>'
        } else {
          result.innerHTML += '<div class="info-box error">âŒ éƒ¨åˆ†è§’è‰²éªŒè¯å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ã€‚</div>'
        }

        // æ˜¾ç¤ºæˆåŠŸåŠ è½½çš„è§’è‰²
        result.innerHTML += '<h3>æˆåŠŸåŠ è½½çš„è§’è‰²ï¼š</h3>'
        characters.forEach((char, index) => {
          result.innerHTML += `<div class="char-card valid">
            <strong>${index + 1}. ${char.basic.nameCn} (${char.basic.nameEn})</strong><br/>
            ID: ${char.basic.id}<br/>
            æ€§åˆ«: ${char.basic.gender}<br/>
            èŒä¸š: ${char.skills.occupation}
          </div>`
        })

      } catch (error) {
        result.innerHTML += `<p class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`
        result.innerHTML += `<pre>${error.stack}</pre>`
      }
    }
  </script>
</body>
</html>
